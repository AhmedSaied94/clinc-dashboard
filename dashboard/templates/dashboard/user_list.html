{% extends 'base.html' %}
{% load static %}
{% block title %}Users - Clinic Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h2">
    <i class="bi bi-people text-primary"></i>
    All Users
  </h1>
  <a href="{% url 'dashboard:user_create' %}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i>
    Add New User
  </a>
</div>

<!-- Search -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form method="get" class="row g-3" id="searchForm">
      <div class="col-md-5">
        <input
          type="text"
          name="search"
          class="form-control"
          placeholder="Search by username, email, or name..."
          value="{{ search_query }}"
        />
      </div>
      <div class="col-md-4">
        <select name="rows" class="form-select" id="rowsSelect">
          {% for option in rows_options %}
          <option value="{{ option }}" {% if current_rows == option|stringformat:"s" %}selected{% endif %}>
            {{ option }} per page
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search"></i>
          Search
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Table -->
<div class="card shadow-sm">
  <div class="card-body">
    {% if users %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Full Name</th>
            <th>Status</th>
            <th>Role</th>
            <th>Date Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td><strong>{{ user.username }}</strong></td>
            <td>{{ user.email|default:"N/A" }}</td>
            <td>
              {% if user.get_full_name %}
                {{ user.get_full_name }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_active %}
              <span class="badge bg-success">Active</span>
              {% else %}
              <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_superuser %}
              <span class="badge bg-danger">Superuser</span>
              {% elif user.is_staff %}
              <span class="badge bg-info">Staff</span>
              {% else %}
              <span class="badge bg-light text-dark">User</span>
              {% endif %}
            </td>
            <td>{{ user.date_joined|date:"Y-m-d" }}</td>
            <td>
              <div class="table-actions">
                <a
                  href="{% url 'dashboard:user_detail' user.pk %}"
                  class="btn btn-action btn-view"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="View Details"
                >
                  <i class="bi bi-eye"></i>
                </a>
                <a
                  href="{% url 'dashboard:user_update' user.pk %}"
                  class="btn btn-action btn-edit"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Edit User"
                >
                  <i class="bi bi-pencil"></i>
                </a>
                <a
                  href="{% url 'dashboard:user_delete' user.pk %}"
                  class="btn btn-action btn-delete"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Delete User"
                  onclick="return confirm('Are you sure you want to delete this user?');"
                >
                  <i class="bi bi-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="d-flex justify-content-between align-items-center mt-4">
      <div class="text-muted">
        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
      </div>
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a
              class="page-link"
              href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if current_rows %}&rows={{ current_rows }}{% endif %}"
              >First</a
            >
          </li>
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_rows %}&rows={{ current_rows }}{% endif %}"
              >Previous</a
            >
          </li>
          {% endif %}

          <li class="page-item active">
            <span class="page-link">
              Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_rows %}&rows={{ current_rows }}{% endif %}"
              >Next</a
            >
          </li>
          <li class="page-item">
            <a
              class="page-link"
              href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if current_rows %}&rows={{ current_rows }}{% endif %}"
              >Last</a
            >
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %} {% else %}
    <div class="empty-state">
      <i class="bi bi-inbox"></i>
      <h4>No Users Found</h4>
      <p>
        {% if search_query %}No users match your search.{% else %}Start by
        adding a new user.{% endif %}
      </p>
      <a href="{% url 'dashboard:user_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i>
        Add New User
      </a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
  // Handle rows per page selector
  document.addEventListener('DOMContentLoaded', function() {
    const rowsSelect = document.getElementById('rowsSelect');
    if (rowsSelect) {
      rowsSelect.addEventListener('change', function() {
        document.getElementById('searchForm').submit();
      });
    }
    
    // Initialize Bootstrap tooltips for action buttons
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
{% endblock %}

